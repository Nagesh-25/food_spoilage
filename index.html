<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food Frehness</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* Add a subtle animation for the freshness status and value updates */
    #freshness, .live-value {
      transition: all 0.5s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="container mx-auto p-4 md:p-6">
    <h1 class="text-3xl font-bold mb-6 text-center text-green-400">üçå Food Quality Dashboard</h1>

    <div class="flex flex-col md:flex-row justify-between items-center mb-4 p-4 bg-gray-800 rounded-lg shadow-lg">
      <div class="mb-4 md:mb-0">
        <label for="food" class="mr-2 text-lg">Select Food Item:</label>
        <select id="food" class="bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-400">
          <option>Banana</option>
          <option>Apple</option>
          <option>Tomato</option>
          <option>Potato</option>
          <option>Rice & Sambar</option>
        </select>
      </div>
      <button onclick="downloadCSV()" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300">‚¨áÔ∏è Download CSV</button>
    </div>

    <div id="freshness" class="text-center text-2xl font-semibold mb-6 p-4 bg-gray-800 rounded-lg shadow-lg">Freshness: ‚è≥ Loading...</div>

    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 text-center mb-6">
      <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
        <h3 class="text-md text-gray-400">MQ-3 (Alcohol)</h3>
        <p id="mq3-value" class="text-2xl font-bold text-red-400 live-value">---</p>
      </div>
      <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
        <h3 class="text-md text-gray-400">MQ-4 (Methane)</h3>
        <p id="mq4-value" class="text-2xl font-bold text-blue-400 live-value">---</p>
      </div>
      <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
        <h3 class="text-md text-gray-400">MQ-135 (Air Quality)</h3>
        <p id="mq135-value" class="text-2xl font-bold text-green-400 live-value">---</p>
      </div>
      <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
        <h3 class="text-md text-gray-400">Temperature</h3>
        <p id="temp-value" class="text-2xl font-bold text-yellow-400 live-value">-- ¬∞C</p>
      </div>
      <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
        <h3 class="text-md text-gray-400">Humidity</h3>
        <p id="hum-value" class="text-2xl font-bold text-cyan-400 live-value">-- %</p>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
        <h2 class="text-xl mb-2 text-center text-blue-400">Gas Sensor Data (MQ Series)</h2>
        <canvas id="gasChart"></canvas>
      </div>
      <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
        <h2 class="text-xl mb-2 text-center text-yellow-400">Temperature & Humidity (DHT11)</h2>
        <canvas id="envChart"></canvas>
      </div>
    </div>
  </div>

<script>
  const gasCtx = document.getElementById('gasChart').getContext('2d');
  const envCtx = document.getElementById('envChart').getContext('2d');
  const freshnessEl = document.getElementById('freshness');

  // === Chart Initialization ===
  const gasChart = new Chart(gasCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'MQ-3', data: [], borderColor: '#f87171', tension: 0.3, fill: false },
        { label: 'MQ-4', data: [], borderColor: '#60a5fa', tension: 0.3, fill: false },
        { label: 'MQ-135', data: [], borderColor: '#34d399', tension: 0.3, fill: false }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: 'white' } }
      },
      scales: {
        x: { ticks: { color: 'white' }, grid: { color: '#333' } },
        y: { ticks: { color: 'white' }, grid: { color: '#333' } }
      }
    }
  });

  const envChart = new Chart(envCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Temperature (¬∞C)', data: [], borderColor: '#facc15', tension: 0.3, fill: false },
        { label: 'Humidity (%)', data: [], borderColor: '#22d3ee', tension: 0.3, fill: false }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: 'white' } }
      },
      scales: {
        x: { ticks: { color: 'white' }, grid: { color: '#333' } },
        y: { ticks: { color: 'white' }, grid: { color: '#333' } }
      }
    }
  });

  // === Freshness Logic ===
  function updateFreshness(temp, hum, mq135) {
    let status = "Fresh", color = "#34d399";
    if (mq135 > 1800 || temp > 28) { status = "Spoiling"; color = "#facc15"; }
    if (mq135 > 2500 || temp > 32) { status = "Spoiled"; color = "#f87171"; }
    freshnessEl.innerHTML = `Freshness: <span style="color:${color}; font-weight: bold;">${status}</span>`;
  }

  // === Fetch and Update Data ===
  async function updateData() {
    try {
      const response = await fetch(`/get_data?_=${new Date().getTime()}`);
      if (!response.ok) {
        console.error(`Failed to fetch data. Server responded with status: ${response.status}`);
        return;
      }

      const readings = await response.json();
      if (!readings || readings.length === 0) return;

      const labels = readings.map(r => r.time);
      const last = readings[readings.length - 1];

      // Update live values
      document.getElementById('mq3-value').textContent = last.mq3;
      document.getElementById('mq4-value').textContent = last.mq4;
      document.getElementById('mq135-value').textContent = last.mq135;
      document.getElementById('temp-value').textContent = `${last.temp.toFixed(1)} ¬∞C`;
      document.getElementById('hum-value').textContent = `${last.hum.toFixed(1)} %`;

      // Update charts
      gasChart.data.labels = labels;
      gasChart.data.datasets[0].data = readings.map(r => r.mq3);
      gasChart.data.datasets[1].data = readings.map(r => r.mq4);
      gasChart.data.datasets[2].data = readings.map(r => r.mq135);
      gasChart.update();

      envChart.data.labels = labels;
      envChart.data.datasets[0].data = readings.map(r => r.temp);
      envChart.data.datasets[1].data = readings.map(r => r.hum);
      envChart.update();

      updateFreshness(last.temp, last.hum, last.mq135);

    } catch (error) {
      console.error("A JavaScript error occurred while fetching data:", error);
    }
  }

  // === CSV Download ===
  function downloadCSV() {
    window.location.href = '/download_csv';
  }

  setInterval(updateData, 3000);
  window.onload = updateData;
</script>

</body>
</html>



